// ==UserScript==
// @name         Bgm.tv auto tracker
// @namespace    https://trim21.me/
// @description  auto tracker your bangumi progress
// @version      0.4.1
// @author       Trim21
// @match        https://www.bilibili.com/bangumi/play/*
// @match        https://bangumi-auto-tracker.trim21.cn/oauth_callback*
// @match        https://bangumi-auto-tracker.trim21.cn/userscript/options*
// @require      https://cdn.bootcss.com/axios/0.18.0/axios.js
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_openInTab
// @grant        GM_addStyle
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @connect      localhost
// @connect      api.bgm.tv
// @connect      bangumi-auto-tracker.trim21.cn
// @run-at       document-end
// ==/UserScript==

!function(){"use strict";let t,e=unsafeWindow,i=GM_xmlhttpRequest,a=GM_setValue,r=GM_getValue,o=GM_openInTab,n=GM_addStyle,s={};console.log("hello world");let c=e.jQuery;function _(t){let e=new Date;c("#bgm_tv_tracker_notification").prepend(`<hr><p>${e.getHours()}:${e.getMinutes()}:${e.getSeconds()} ${t}</p>`)}c||console.log("no jquery in this page");const d=function(t){let e={},i=/^([^: \t]+):[ \t]*((?:.*[^ \t])|)/.exec(t),a=i&&i[1];return e[a=a.toLowerCase()]=i[2],e},l=(t,e)=>i=>{i.headers=function(t){let e={};for(let i of t.trim().split("\r"))(i=i.trim())&&Object.assign(e,d(i));return e}(i.responseHeaders),i.status<300?(i.headers["content-type"].startsWith("application/json")&&(i.data=JSON.parse(i.responseText)),t(i)):(console.log(i),i.headers["content-type"].startsWith("application/json")&&(i.data=JSON.parse(i.responseText)),e({response:i}))},p={get:(t,e={})=>new Promise((a,r)=>{i({method:"GET",url:t,headers:e,onload:l(a,r)})}),post:(t,e={},a={})=>(null!==e&&"object"==typeof e&&(e=JSON.stringify(e),a["content-Type"]="application/json"),new Promise((r,o)=>{i({method:"POST",data:e,url:t,headers:a,onload:l(r,o)})}))},m={get:(t,e={})=>new Promise((i,a)=>{p.get(t,e).then(t=>{if(401===t.data.code){a({response:t})}else i(t)},t=>a(t))}),post:(t,e={},i={})=>new Promise((a,r)=>{p.post(t,e,i).then(t=>{a(t)},t=>r(t))})},g={apiServerURL:"https://bangumi-auto-tracker.trim21.cn",callBackUrl:"https://bangumi-auto-tracker.trim21.cn/oauth_callback",apiBgmUrl:"https://api.bgm.tv",authURL:""};function b(i,a){p.post(`${g.apiServerURL}/api/v0.1/collectBangumiData`,{bangumi_id:i,ep:a,user_id:t.user_id,auth:t.access_token,href:e.location.href})}g.authURL="https://bgm.tv/oauth/authorize?client_id=bgm2775b2797b4d958b&response_type=code&redirect_uri="+g.callBackUrl,"dev"===window.TM_ENV&&(g.apiServerURL="http://localhost:6001",console.log("dev"));let u=r("collection",!1);function h(e){u[e]||p.post(`${g.apiBgmUrl}/collection/${e}/update`,"status=do",{"content-type":"application/x-www-form-urlencoded",Authorization:"Bearer "+t.access_token}).then(t=>{401===t.data.code?_(t.data.error):(_("add this bangumi to your collection"),u[e]=!0,a("collection",JSON.stringify(u)))},t=>_(t.response.data.error_description))}function f(e){var i;h(e.subject_id),(i=e.subject_id,new Promise((t,e)=>{let o=r(`eps_${i}`,!1);o?(o=JSON.parse(o),Number((new Date).getTime()/1e3)-o.time>7200?p.get(`${g.apiBgmUrl}/subject/${i}/ep`).then(e=>{e.data.time=Number((new Date).getTime()/1e3),a(`eps_${i}`,JSON.stringify(e.data)),t(e.data)},t=>{e(t),_("get bgm eps error")}):t(o)):m.get(`${g.apiBgmUrl}/subject/${i}/ep`).then(e=>{e.data.time=Number((new Date).getTime()/1e3),a(`eps_${i}`,JSON.stringify(e.data)),t(e.data)},t=>{e(t),_("get bgm eps error")})})).then(i=>{let a=i.eps[parseInt(e.episode)-1].id;p.post(`${g.apiBgmUrl}/ep/${a}/status/watched`,null,{Authorization:"Bearer "+t.access_token}).then(()=>_("mark your status successfully".toString()),t=>_(JSON.stringify(t.response.data)))},t=>_(JSON.stringify(t.response.data))).catch(function(t){_(t.toString())})}if(u=u?JSON.parse(u):{},e.location.href.startsWith(g.callBackUrl)){if(e.data){a("auth",JSON.stringify(e.data));let t=e.document.createElement("h1");t.innerText="成功授权 请关闭网页",e.document.body.appendChild(t)}}else if(t=r("auth",!1))t=JSON.parse(t);else{e.alert("you need to auth bgm.tv_auto_tracker first")&&o(g.authURL,{active:!0})}if(e.location.href.startsWith("https://www.bilibili.com/bangumi/play/")){console.log("inject bilibili"),function(){const i=e.__INITIAL_STATE__,a=i.epInfo.index,r=i.mediaInfo.season_id;s.bangumiID=i.mediaInfo.season_id,s.episode=a,b(i.mediaInfo.season_id,a),c("#bangumi_detail > div > div.info-right > div.info-title.clearfix > div.func-module.clearfix").prepend('<div id="bgm_tv_tracker" class="disable" data-id=""><div class="bgm_tv_tracker_btn bgm_tv_tracker bgm_tv_tracker_radius">bgm.tv</div><div class="bgm_tv_tracker_info"><br><div><p>你正在看: <span id="bgm_tv_tracker_title"></span></p><p>第 <span id="bgm_tv_tracker_episode">{episode}</span>集</p></div><br><div id="bgm_tv_tracker_link"></div><br><button class="bgm_tv_tracker_radius" id="bgm_tv_tracker_mark_watch">标记本集为看过</button> <button class="bgm_tv_tracker_radius" id="bgm_tv_tracker_mark_watched">看到本集</button><br><br><a href="https://github.com/Trim21/bilibili-bangumi-tv-auto-tracker/issues" target="_blank" rel="noopener noreferrer">报告问题</a><br><div id="bgm_tv_tracker_notification"></div></div></div>'),c("#bgm_tv_tracker_episode").html(a),c("#bgm_tv_tracker").data("id",r),n("#bgm_tv_tracker{display:inline-block;position:relative;float:left;margin-right:20px;user-select:none}.bgm_tv_tracker_radius{border-radius:4px;border:1px solid #e5e9ef}.bgm_tv_tracker_btn.bgm_tv_tracker{color:#6d757a;float:left;cursor:pointer;font-size:14px;height:28px;line-height:28px;text-align:center;width:80px!important;transition:all .1s ease-in}.bangumi-info .info-right .info-title.clearfix h2{width:380px}@media screen and (max-width:1400px){.arc-toolbar .block{padding:0 12px;margin-left:-12px}.video-toolbar-module .btn-item{padding:0 0 0 60px!important;margin-left:-12px}.bangumi-info .info-right .info-title.clearfix h2{width:200px!important}}#bgm_tv_tracker.disable .bgm_tv_tracker_info{display:none}.bgm_tv_tracker_info{padding:8px;margin-top:5px;background:#fff;border-radius:0 0 4px 4px;border:1px solid #e5e9ef;box-shadow:rgba(0,0,0,.16) 0 2px 4px;cursor:default;height:auto;left:-1px;line-height:normal;opacity:0;pointer-events:none;position:absolute;text-align:left;top:70px;white-space:normal;width:300px;z-index:1000}.bgm_tv_tracker_info *{max-width:100%}#bgm_tv_tracker .bgm_tv_tracker_info{opacity:1;pointer-events:auto;top:100%}.bgm_tv_tracker_info button{padding:4px 6px;line-height:14px;display:inline-block;margin:4px}");let o=c(".bgm_tv_tracker_info");c(".bgm_tv_tracker_btn.bgm_tv_tracker").click(()=>{o.toggle("fast")}).hover(function(){c(this).css("background-color","#00A1D6"),c(this).css("color","white")},function(){c(this).css("background-color","white"),c(this).css("color","black")}),c("#bgm_tv_tracker_title").html(i.mediaInfo.title),p.get(`${g.apiServerURL}/query/bilibili?bangumi_id=${r}`).then(e=>{let i=e.data.bangumi_id||e.data.subject_id;s.subjectID=i,c("#bgm_tv_tracker_link").html(`<a href="http://bgm.tv/subject/${i}" target="_blank" rel="noopener noreferrer">subject/${i}</a>`),c("#bgm_tv_tracker_mark_watched").click(()=>{let e=c("#bgm_tv_tracker_episode").html();h(i),m.post(`https://api.bgm.tv/subject/${i}/update/watched_eps?watched_eps=${e}`,`watched_eps=${e}`,{"content-type":"application/x-www-form-urlencoded",Authorization:"Bearer "+t.access_token}).then(t=>{202===t.data.code?_("mark status successful"):_("error: "+JSON.stringify(t.data))},t=>_("error: "+JSON.stringify(t)))}),c("#bgm_tv_tracker_mark_watch").click(()=>{f({subject_id:i,type:"watch_episode",website:"bilibili",bangumi_id:c("#bgm_tv_tracker").data("id"),title:c("#bgm_tv_tracker_title").html(),episode:c("#bgm_tv_tracker_episode").html()})})},t=>{404===t.response.status&&c(".bgm_tv_tracker_info").html("没找到你在看的番剧")})}();let i=e.__INITIAL_STATE__.epInfo.index;const a=function(){const t=e.__INITIAL_STATE__,i=t.epInfo.index;s.bangumiID=t.mediaInfo.season_id,s.episode=i,b(t.mediaInfo.season_id,i),c("#bgm_tv_tracker_episode").html(i)},r=function(){console.log("check href"),i!==e.__INITIAL_STATE__.epInfo.index&&(a(),i=e.__INITIAL_STATE__.epInfo.index)};setInterval(r,1e4),setTimeout(r,5e3)}}();